{"version":3,"file":"/Users/mwistrand/projects/dojo/widgets/src/grid/Body.ts","sourceRoot":"","sources":["../node_modules/tslint-loader/index.js??ref--4!/Users/mwistrand/projects/dojo/widgets/node_modules/@dojo/webpack-contrib/css-module-dts-loader/index.js?type=ts&instanceName=0_custom-elements!/Users/mwistrand/projects/dojo/widgets/src/grid/Body.ts"],"names":[],"mappings":";AAAA,OAAO,MAAM,MAAM,6BAA6B,CAAC;AACjD,OAAO,UAAU,MAAM,wCAAwC,CAAC;AAChE,OAAO,EAAE,CAAC,EAAE,CAAC,EAAE,MAAM,+BAA+B,CAAC;AACrD,OAAO,WAAW,EAAE,EAAE,KAAK,EAAE,MAAM,2CAA2C,CAAC;AAE/E,OAAO,QAAQ,MAAM,kCAAkC,CAAC;AAGxD,OAAO,cAAc,MAAM,kBAAkB,CAAC;AAC9C,OAAO,GAAG,MAAM,OAAO,CAAC;AAExB,OAAO,KAAK,QAAQ,MAAM,qBAAqB,CAAC;AAChD,OAAO,KAAK,GAAG,MAAM,0BAA0B,CAAC;AAChD,OAAO,EAAE,YAAY,EAAE,MAAM,qDAAqD,CAAC;AACnF,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,kCAAkC,CAAC;AAenE,MAAM,SAAS,GAAG,CAAC,KAAY,EAAE,EAAE;IAClC,MAAM,CAAC,GAAG,QAAQ,CAAC,GAAG,EAAE,CACvB,CAAC,CACA,KAAM,SAAQ,UAAU;QACvB,MAAM;YACL,MAAM,CAAC,KAAK,CAAC;QACd,CAAC;KACD,EACD,EAAE,CACF,CACD,CAAC;IACF,MAAM,GAAG,GAAG,MAAM,CAAC,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;IACjD,GAAG,CAAC,KAAK,CAAC,QAAQ,GAAG,UAAU,CAAC;IAChC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;IACtC,CAAC,CAAC,KAAK,CAAC,EAAE,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;IACtC,MAAM,UAAU,GAAG,GAAG,CAAC,qBAAqB,EAAE,CAAC;IAC/C,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;IACtC,MAAM,CAAC,UAAU,CAAC;AACnB,CAAC,CAAC;AAEF,MAAM,6BAA6B,GAAG,CAAC,KAAa,EAAE,EAAE;IACvD,MAAM,CAAC,CAAC,CAAC,cAAc,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,CAAC,CAAC;AAC1C,CAAC,CAAC;AAIF,IAAqB,IAAI,GAAzB,UAA6B,SAAQ,WAAW,CAAC,UAAU,CAAoB;IAF/E;;QAMS,WAAM,GAAG,CAAC,CAAC;QACX,SAAI,GAAG,GAAG,CAAC;QACX,iBAAY,GAAG,KAAK,CAAC;IAiJ9B,CAAC;IA/IQ,QAAQ,CAAC,SAAiB,EAAE,QAAgB,EAAE,KAAU;QAC/D,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;QAC1E,MAAM,cAAc,GAAG,SAAS,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC;QACzE,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,EAAE,cAAc,EAAE,QAAQ,EAAE,KAAK,CAAC,CAAC;IAChE,CAAC;IAEO,SAAS,CAAC,KAAc;QAC/B,MAAM,EAAE,SAAS,GAAG,CAAC,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC;QAC1C,MAAM,SAAS,GAAI,KAAK,CAAC,MAAsB,CAAC,SAAS,CAAC;QAC1D,MAAM,UAAU,GAAI,KAAK,CAAC,MAAsB,CAAC,UAAU,CAAC;QAC5D,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC;QACvD,MAAM,SAAS,GAAG,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC;QAC5C,EAAE,CAAC,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;YAC3B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC,CAAC;YACzD,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC,CAAC;QACzE,CAAC;QACD,EAAE,CAAC,CAAC,SAAS,IAAI,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YAC5B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,CAAC;YACjE,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC,CAAC;QACzE,CAAC;QACD,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;QACrC,IAAI,CAAC,UAAU,EAAE,CAAC;IACnB,CAAC;IAGS,gBAAgB;QACzB,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC;QAChB,IAAI,CAAC,IAAI,GAAG,GAAG,CAAC;QAChB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;IAC1B,CAAC;IAEO,WAAW,CAAC,KAAa,EAAE,GAAW;QAC7C,MAAM,EACL,QAAQ,EACR,OAAO,EACP,KAAK,EACL,YAAY,EACZ,sBAAsB,GAAG,6BAA6B,EACtD,UAAU,EACV,SAAS,EACT,KAAK,EACL,OAAO,EACP,GAAG,IAAI,CAAC,UAAU,CAAC;QAEpB,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,GAAG,QAAQ,CAAC,CAAC;QAE1C,IAAI,IAAI,GAAG,KAAK,CAAC,QAAQ,SAAS,EAAE,CAAC,IAAI,EAAE,CAAC;QAE5C,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,SAAS,KAAK,SAAS,IAAI,SAAS,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YAChE,OAAO,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;QAC9B,CAAC;QAED,EAAE,CAAC,CAAC,SAAS,KAAK,OAAO,CAAC,CAAC,CAAC;YAC3B,MAAM,OAAO,GAAG,KAAK,CAAC,QAAQ,OAAO,EAAE,CAAC,IAAI,EAAE,CAAC;YAC/C,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;gBACrB,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;YAC5B,CAAC;YACD,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;YACxF,UAAU,CAAC,aAAa,CAAC,CAAC;YAC1B,IAAI,GAAG,CAAC,GAAG,IAAI,EAAE,GAAG,OAAO,CAAC,CAAC;QAC9B,CAAC;QAAC,IAAI,CAAC,CAAC;YACP,UAAU,CAAC,SAAS,CAAC,CAAC;QACvB,CAAC;QAED,MAAM,IAAI,GAAY,EAAE,CAAC;QAEzB,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC;YAClC,MAAM,MAAM,GAAG,CAAC,GAAG,CAAC,SAAS,GAAG,QAAQ,GAAG,QAAQ,CAAC,CAAC;YACrD,MAAM,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;YAC1B,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;gBACV,IAAI,CAAC,IAAI,CACR,CAAC,CAAC,GAAG,EAAE;oBACN,EAAE,EAAE,CAAC;oBACL,GAAG,EAAE,CAAC;oBACN,KAAK;oBACL,OAAO;oBACP,IAAI;oBACJ,YAAY;oBACZ,OAAO,EAAE,IAAI,CAAC,QAAQ;iBACtB,CAAC,CACF,CAAC;YACH,CAAC;YAAC,IAAI,CAAC,CAAC;gBACP,EAAE,CAAC,CAAC,SAAS,KAAK,SAAS,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;oBAC1D,IAAI,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC,CAAC;gBACtC,CAAC;YACF,CAAC;QACF,CAAC;QAED,MAAM,CAAC,IAAI,CAAC;IACb,CAAC;IAES,MAAM;QACf,MAAM,EACL,sBAAsB,GAAG,6BAA6B,EACtD,SAAS,GAAG,CAAC,EACb,QAAQ,EACR,MAAM,EACN,GAAG,IAAI,CAAC,UAAU,CAAC;QAEpB,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;YACtB,MAAM,QAAQ,GAAG,sBAAsB,CAAC,CAAC,CAAC,CAAC;YAC3C,MAAM,UAAU,GAAG,SAAS,CAAC,QAAQ,CAAC,CAAC;YACvC,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC,MAAM,CAAC;YACpC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC;YACvD,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;QAC7C,CAAC;QAED,MAAM,IAAI,GAAY,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/D,MAAM,gBAAgB,GAAG,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,MAAM,CAAC;QACvD,IAAI,mBAAmB,GAAG,CAAC,CAAC;QAC5B,EAAE,CAAC,CAAC,SAAS,IAAI,QAAQ,CAAC,CAAC,CAAC;YAC3B,mBAAmB;gBAClB,SAAS,GAAG,IAAI,CAAC,UAAU;oBAC3B,gBAAgB;oBAChB,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC;QAC9C,CAAC;QAED,IAAI,mBAAmB,GAAoB;YAC1C,GAAG,EAAE,MAAM;YACX,OAAO,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,QAAQ,CAAC,SAAS,CAAC;YACnD,IAAI,EAAE,UAAU;YAChB,QAAQ,EAAE,IAAI,CAAC,SAAS;YACxB,MAAM,EAAE,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,EAAE;SACjC,CAAC;QAEF,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;YACvB,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;YAC1B,mBAAmB,qBACf,mBAAmB,IACtB,SAAS,EAAE,CAAC,GACZ,CAAC;QACH,CAAC;QAED,MAAM,CAAC,CAAC,CAAC,KAAK,EAAE,mBAAmB,EAAE;YACpC,CAAC,CAAC,KAAK,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,GAAG,gBAAgB,IAAI,EAAE,EAAE,CAAC;YACrE,GAAG,IAAI;YACP,CAAC,CAAC,KAAK,EAAE;gBACR,GAAG,EAAE,QAAQ;gBACb,MAAM,EAAE,EAAE,MAAM,EAAE,GAAG,mBAAmB,IAAI,EAAE;aAC9C,CAAC;SACF,CAAC,CAAC;IACJ,CAAC;CACD,CAAA;AAtHA;IADC,YAAY,CAAC,WAAW,EAAE,IAAI,CAAC;;;;4CAK/B;AArCmB,IAAI;IAFxB,KAAK,CAAC,GAAG,CAAC;IACV,YAAY,CAAC,OAAO,EAAE,SAAS,CAAC;GACZ,IAAI,CAuJxB;eAvJoB,IAAI","sourcesContent":["import global from '@dojo/framework/shim/global';\nimport WidgetBase from '@dojo/framework/widget-core/WidgetBase';\nimport { v, w } from '@dojo/framework/widget-core/d';\nimport ThemedMixin, { theme } from '@dojo/framework/widget-core/mixins/Themed';\nimport { DNode, VNodeProperties } from '@dojo/framework/widget-core/interfaces';\nimport renderer from '@dojo/framework/widget-core/vdom';\n\nimport { GridPages, ColumnConfig } from './interfaces';\nimport PlaceholderRow from './PlaceholderRow';\nimport Row from './Row';\n\nimport * as fixedCss from './styles/body.m.css';\nimport * as css from '../theme/grid-body.m.css';\nimport { diffProperty } from '@dojo/framework/widget-core/decorators/diffProperty';\nimport { auto, reference } from '@dojo/framework/widget-core/diff';\n\nexport interface BodyProperties<S> {\n\ttotalRows?: number;\n\tpageSize: number;\n\tpages: GridPages<S>;\n\theight: number;\n\tcolumnConfig: ColumnConfig[];\n\tplaceholderRowRenderer?: (index: number) => DNode;\n\tfetcher: (page: number, pageSize: number) => void;\n\tupdater: (page: number, rowNumber: number, columnId: string, value: string) => void;\n\tpageChange: (page: number) => void;\n\tonScroll: (value: number) => void;\n}\n\nconst offscreen = (dnode: DNode) => {\n\tconst r = renderer(() =>\n\t\tw(\n\t\t\tclass extends WidgetBase {\n\t\t\t\trender() {\n\t\t\t\t\treturn dnode;\n\t\t\t\t}\n\t\t\t},\n\t\t\t{}\n\t\t)\n\t);\n\tconst div = global.document.createElement('div');\n\tdiv.style.position = 'absolute';\n\tglobal.document.body.appendChild(div);\n\tr.mount({ domNode: div, sync: true });\n\tconst dimensions = div.getBoundingClientRect();\n\tglobal.document.body.removeChild(div);\n\treturn dimensions;\n};\n\nconst defaultPlaceholderRowRenderer = (index: number) => {\n\treturn w(PlaceholderRow, { key: index });\n};\n\n@theme(css)\n@diffProperty('pages', reference)\nexport default class Body<S> extends ThemedMixin(WidgetBase)<BodyProperties<S>> {\n\tprivate _rowHeight: number;\n\tprivate _rowsInView: number;\n\tprivate _renderPageSize: number;\n\tprivate _start = 0;\n\tprivate _end = 100;\n\tprivate _resetScroll = false;\n\n\tprivate _updater(rowNumber: number, columnId: string, value: any) {\n\t\tconst page = Math.max(Math.ceil(rowNumber / this.properties.pageSize), 1);\n\t\tconst pageItemNumber = rowNumber - (page - 1) * this.properties.pageSize;\n\t\tthis.properties.updater(page, pageItemNumber, columnId, value);\n\t}\n\n\tprivate _onScroll(event: UIEvent) {\n\t\tconst { totalRows = 0 } = this.properties;\n\t\tconst scrollTop = (event.target as HTMLElement).scrollTop;\n\t\tconst scrollLeft = (event.target as HTMLElement).scrollLeft;\n\t\tconst topRow = Math.round(scrollTop / this._rowHeight);\n\t\tconst bottomRow = topRow + this._rowsInView;\n\t\tif (topRow <= this._start) {\n\t\t\tthis._start = Math.max(0, topRow - this._renderPageSize);\n\t\t\tthis._end = Math.min(totalRows, this._start + this._renderPageSize * 2);\n\t\t}\n\t\tif (bottomRow >= this._end) {\n\t\t\tthis._start = Math.min(topRow, totalRows - this._renderPageSize);\n\t\t\tthis._end = Math.min(totalRows, this._start + this._renderPageSize * 2);\n\t\t}\n\t\tthis.properties.onScroll(scrollLeft);\n\t\tthis.invalidate();\n\t}\n\n\t@diffProperty('totalRows', auto)\n\tprotected _onDiffTotalRows() {\n\t\tthis._start = 0;\n\t\tthis._end = 100;\n\t\tthis._resetScroll = true;\n\t}\n\n\tprivate _renderRows(start: number, end: number) {\n\t\tconst {\n\t\t\tpageSize,\n\t\t\tfetcher,\n\t\t\tpages,\n\t\t\tcolumnConfig,\n\t\t\tplaceholderRowRenderer = defaultPlaceholderRowRenderer,\n\t\t\tpageChange,\n\t\t\ttotalRows,\n\t\t\ttheme,\n\t\t\tclasses\n\t\t} = this.properties;\n\n\t\tconst startPage = Math.max(Math.ceil(start / pageSize), 1);\n\t\tconst endPage = Math.ceil(end / pageSize);\n\n\t\tlet data = pages[`page-${startPage}`] || [];\n\n\t\tif (!data.length && (totalRows === undefined || totalRows > 0)) {\n\t\t\tfetcher(startPage, pageSize);\n\t\t}\n\n\t\tif (startPage !== endPage) {\n\t\t\tconst endData = pages[`page-${endPage}`] || [];\n\t\t\tif (!endData.length) {\n\t\t\t\tfetcher(endPage, pageSize);\n\t\t\t}\n\t\t\tconst midScreenPage = Math.max(Math.ceil((start + this._rowsInView / 2) / pageSize), 1);\n\t\t\tpageChange(midScreenPage);\n\t\t\tdata = [...data, ...endData];\n\t\t} else {\n\t\t\tpageChange(startPage);\n\t\t}\n\n\t\tconst rows: DNode[] = [];\n\n\t\tfor (let i = start; i < end; i++) {\n\t\t\tconst offset = i - (startPage * pageSize - pageSize);\n\t\t\tconst item = data[offset];\n\t\t\tif (item) {\n\t\t\t\trows.push(\n\t\t\t\t\tw(Row, {\n\t\t\t\t\t\tid: i,\n\t\t\t\t\t\tkey: i,\n\t\t\t\t\t\ttheme,\n\t\t\t\t\t\tclasses,\n\t\t\t\t\t\titem,\n\t\t\t\t\t\tcolumnConfig,\n\t\t\t\t\t\tupdater: this._updater\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tif (totalRows === undefined || (i > -1 && i < totalRows)) {\n\t\t\t\t\trows.push(placeholderRowRenderer(i));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn rows;\n\t}\n\n\tprotected render(): DNode {\n\t\tconst {\n\t\t\tplaceholderRowRenderer = defaultPlaceholderRowRenderer,\n\t\t\ttotalRows = 0,\n\t\t\tpageSize,\n\t\t\theight\n\t\t} = this.properties;\n\n\t\tif (!this._rowHeight) {\n\t\t\tconst firstRow = placeholderRowRenderer(0);\n\t\t\tconst dimensions = offscreen(firstRow);\n\t\t\tthis._rowHeight = dimensions.height;\n\t\t\tthis._rowsInView = Math.ceil(height / this._rowHeight);\n\t\t\tthis._renderPageSize = this._rowsInView * 2;\n\t\t}\n\n\t\tconst rows: DNode[] = this._renderRows(this._start, this._end);\n\t\tconst topPaddingHeight = this._rowHeight * this._start;\n\t\tlet bottomPaddingHeight = 0;\n\t\tif (totalRows >= pageSize) {\n\t\t\tbottomPaddingHeight =\n\t\t\t\ttotalRows * this._rowHeight -\n\t\t\t\ttopPaddingHeight -\n\t\t\t\t(this._end - this._start) * this._rowHeight;\n\t\t}\n\n\t\tlet containerProperties: VNodeProperties = {\n\t\t\tkey: 'root',\n\t\t\tclasses: [this.theme(css.root), fixedCss.rootFixed],\n\t\t\trole: 'rowgroup',\n\t\t\tonscroll: this._onScroll,\n\t\t\tstyles: { height: `${height}px` }\n\t\t};\n\n\t\tif (this._resetScroll) {\n\t\t\tthis._resetScroll = false;\n\t\t\tcontainerProperties = {\n\t\t\t\t...containerProperties,\n\t\t\t\tscrollTop: 0\n\t\t\t};\n\t\t}\n\n\t\treturn v('div', containerProperties, [\n\t\t\tv('div', { key: 'top', styles: { height: `${topPaddingHeight}px` } }),\n\t\t\t...rows,\n\t\t\tv('div', {\n\t\t\t\tkey: 'bottom',\n\t\t\t\tstyles: { height: `${bottomPaddingHeight}px` }\n\t\t\t})\n\t\t]);\n\t}\n}\n"]}